{"version":3,"file":"handler.protected.js","mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;ACnHA;;;;;;;;;;ACAA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AEvBA;AACA;AACA;AACA","sources":["/Users/johanhenkens/Repositories/personal_projects/bvnsp-signin-twilio/src/handler.protected.ts","/Users/johanhenkens/Repositories/personal_projects/bvnsp-signin-twilio/src/util.ts","external commonjs \"@twilio-labs/serverless-runtime-types\"","external commonjs \"googleapis\"","webpack/bootstrap","webpack/before-startup","webpack/startup","webpack/after-startup"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.handler = void 0;\nrequire(\"@twilio-labs/serverless-runtime-types\");\nconst util_1 = require(\"./util\");\nconst handler = function (context, event, callback) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const response = new Twilio.Response();\n        const twiml = new Twilio.twiml.MessagingResponse();\n        // Cookies are accessed by name from the event.request.cookies object\n        // If the user doesn't have a count yet, initialize it to zero. Cookies are\n        // always strings, so you'll need to convert the count to a number\n        const count = Number(event.request.cookies.count) || 0;\n        // Return a dynamic message based on if this is the first message or not\n        let message = count > 0\n            ? `Your current count is ${count}`\n            : \"Hello, thanks for the new message!\";\n        const SCOPES = [\n            \"https://www.googleapis.com/auth/spreadsheets.readonly\",\n        ];\n        const sheets_service = (0, util_1.get_sheets_service)((0, util_1.get_service_auth)(SCOPES));\n        const phone_lookup = yield (0, util_1.find_patroller_from_number)(\"+16508046698\", sheets_service, context);\n        message = `Hello ${phone_lookup.name}.\\n${message}`;\n        twiml.message(message);\n        response\n            // Add the stringified TwiML to the response body\n            .setBody(twiml.toString())\n            // Since we're returning TwiML, the content type must be XML\n            .appendHeader(\"Content-Type\", \"text/xml\")\n            // You can increment the count state for the next message, or any other\n            // operation that makes sense for your application's needs. Remember\n            // that cookies are always stored as strings\n            .setCookie(\"count\", (count + 1).toString());\n        return callback(null, response);\n    });\n};\nexports.handler = handler;\n","\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.get_service_auth = exports.get_sheets_service = exports.logAction = exports.find_patroller_from_number = exports.lookup_row_col_in_sheet = exports.split_to_row_col = exports.sanitize_number = exports.strip_datetime_to_date = exports.parse_time_to_utc = exports.excel_date_to_js_date = exports.parse_patroller_row = exports.excel_row_to_index = void 0;\nconst googleapis_1 = require(\"googleapis\");\nfunction get_service_auth(scopes) {\n    return new googleapis_1.google.auth.GoogleAuth({\n        keyFile: Runtime.getAssets()[\"/service-credentials.json\"].path,\n        scopes: scopes,\n    });\n}\nexports.get_service_auth = get_service_auth;\nfunction get_sheets_service(auth) {\n    return googleapis_1.google.sheets({ version: \"v4\", auth: auth });\n}\nexports.get_sheets_service = get_sheets_service;\nfunction find_patroller_from_number(raw_number, sheets_service, context) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const number = sanitize_number(raw_number);\n        const response = yield sheets_service.spreadsheets.values.get({\n            spreadsheetId: context.SHEET_ID,\n            range: context.PHONE_NUMBER_LOOKUP_SHEET,\n            valueRenderOption: \"UNFORMATTED_VALUE\",\n        });\n        if (!response.data.values) {\n            throw new Error(\"Could not find patroller.\");\n        }\n        const patroller = response.data.values\n            .map((row) => {\n            const rawNumber = row[excel_row_to_index(context.PHONE_NUMBER_NUMBER_COLUMN)];\n            const currentNumber = rawNumber != undefined ? sanitize_number(rawNumber) : rawNumber;\n            const currentName = row[excel_row_to_index(context.PHONE_NUMBER_NAME_COLUMN)];\n            return { name: currentName, number: currentNumber };\n        })\n            .filter((patroller) => {\n            if (patroller.number === number) {\n                console.log(`Hello ${patroller.name}`);\n                return true;\n            }\n        })[0];\n        return patroller;\n    });\n}\nexports.find_patroller_from_number = find_patroller_from_number;\nfunction split_to_row_col(excel_index) {\n    const col = excel_row_to_index(excel_index[0]);\n    const row = Number(excel_index[1]) - 1;\n    return [row, col];\n}\nexports.split_to_row_col = split_to_row_col;\nfunction lookup_row_col_in_sheet(excel_index, sheet) {\n    const [row, col] = split_to_row_col(excel_index);\n    return sheet[row][col];\n}\nexports.lookup_row_col_in_sheet = lookup_row_col_in_sheet;\nfunction excel_row_to_index(row) {\n    return row.toLowerCase().charCodeAt(0) - \"a\".charCodeAt(0);\n}\nexports.excel_row_to_index = excel_row_to_index;\nfunction sanitize_number(number) {\n    let new_number = number.toString();\n    new_number = new_number.replace(\"whatsapp:\", \"\");\n    new_number = new_number.replace(/(^\\+1|\\(|\\)|\\.|-)/g, \"\");\n    if (new_number.startsWith(\"+1\")) {\n        new_number = new_number.substring(2);\n    }\n    return parseInt(new_number);\n}\nexports.sanitize_number = sanitize_number;\nfunction parse_patroller_row(index, row, context) {\n    return {\n        index: index,\n        name: row[0],\n        section: row[excel_row_to_index(context.SECTION_DROPDOWN_COLUMN)],\n        checkin: row[excel_row_to_index(context.CHECKIN_DROPDOWN_COLUMN)],\n    };\n}\nexports.parse_patroller_row = parse_patroller_row;\nfunction excel_date_to_js_date(date) {\n    const result = new Date(0);\n    result.setUTCMilliseconds(Math.round((date - 25569) * 86400 * 1000));\n    // console.log(`DEBUG: excel_date_to_js_date (${result})`)\n    return result;\n}\nexports.excel_date_to_js_date = excel_date_to_js_date;\nfunction parse_time_to_utc(date) {\n    const result = new Date(date.toUTCString().replace(\" GMT\", \" PST\"));\n    // console.log(`DEBUG: parse_time_to_utc (${result})`)\n    return result;\n}\nexports.parse_time_to_utc = parse_time_to_utc;\nfunction strip_datetime_to_date(date) {\n    const result = new Date(date.toLocaleDateString(\"en-US\", { timeZone: \"America/Los_Angeles\" }));\n    // console.log(`DEBUG: strip_datetime_to_date (${result})`)\n    return result;\n}\nexports.strip_datetime_to_date = strip_datetime_to_date;\nfunction logAction(patroller_name, sheets_service, sheet_id, user_statistics_sheet, action) {\n    return __awaiter(this, void 0, void 0, function* () {\n        yield sheets_service.spreadsheets.values.append({\n            spreadsheetId: sheet_id,\n            range: user_statistics_sheet,\n            valueInputOption: \"USER_ENTERED\",\n            requestBody: { values: [[patroller_name, new Date(), action]] },\n        });\n    });\n}\nexports.logAction = logAction;\n","module.exports = require(\"@twilio-labs/serverless-runtime-types\");","module.exports = require(\"googleapis\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(\"./src/handler.protected.ts\");\n",""],"names":[],"sourceRoot":""}